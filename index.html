<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>हमर बिरसा प्रतियोगिता 2025</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; }
body { font-family: 'Roboto', sans-serif; margin:0; padding:0; background:#f0f2f5; }
.container { max-width:720px; margin:40px auto; background:#fff; padding:28px; border-radius:12px; box-shadow:0 6px 24px rgba(0,0,0,0.08); }
h2 { text-align:center; color:#007BFF; margin-bottom:16px; }
form label { display:block; margin:12px 0 6px; font-weight:500; }
input, select, textarea { width:100%; padding:10px; border:1px solid #d0d7df; border-radius:8px; font-size:15px; }
input:focus, select:focus, textarea:focus { outline:none; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,0.08); }
button { padding:12px 20px; background:#007BFF; color:#fff; border:none; border-radius:8px; cursor:pointer; margin-top:18px; font-size:16px; transition:background .18s; }
button:hover { background:#0056b3; }
.slip { display:none; text-align:center; margin-top:20px; padding:20px; border-radius:10px; background:#e9fff0; box-shadow:0 6px 18px rgba(0,0,0,0.04); }
.slip .qr-row { display:flex; gap:18px; justify-content:center; align-items:center; flex-wrap:wrap; margin:12px 0; }
.qr-box { background:#fff; padding:12px; border-radius:8px; box-shadow:0 4px 10px rgba(0,0,0,0.04); text-align:center; }
.qr-box canvas { width:170px; height:170px; display:block; margin:0 auto; }
.info { font-size:15px; color:#111827; margin-top:6px; }
.upi-id { font-weight:700; color:#0b5cff; word-break:break-all; }
.small-muted { color:#6b7280; font-size:13px; }
@media (max-width: 600px) {
  .container { margin:18px; padding:18px; }
  .qr-box canvas { width:140px; height:140px; }
}
</style>
</head>
<body>
<div class="container">
  <h2>हमर बिरसा सामान्य ज्ञान प्रतियोगिता 2025</h2>

  <form id="examForm">
    <label>नाम:</label><input type="text" name="name" required>
    <label>शिक्षा:</label><input type="text" name="education">
    <label>विद्यालय / कॉलेज:</label><input type="text" name="school">
    <label>लिंग:</label>
    <select name="gender" required>
      <option value="">--Select--</option>
      <option value="पुरुष">पुरुष</option>
      <option value="महिला">महिला</option>
      <option value="अन्य">अन्य</option>
    </select>
    <label>Email:</label><input type="email" name="email">
    <label>मोबाइल:</label><input type="tel" name="mobile" required>
    <label>पता:</label><textarea name="address" required></textarea>
    <label>Transaction ID:</label><input type="text" name="txnid" required>
    <label>Payment Screenshot:</label><input type="file" name="screenshot" accept="image/*" required>
    <button type="submit">सबमिट करें</button>
  </form>

  <div class="slip" id="slip" aria-live="polite">
    <h3>आपका प्रवेश पत्र</h3>

    <div id="slipDetails" class="info"></div>

    <!-- UPI block will be inserted here (just above Transaction ID) -->
    <!-- We will show: UPI ID text + small "Scan to pay" label + UPI QR -->
    <div id="upiBlock" class="qr-row" style="display:none; margin-top:12px;"></div>

    <!-- Entry QR (student identifier) shown as separate QR box -->
    <div id="entryQrBox" class="qr-row" style="display:none;"></div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
/* --------- CONFIG --------- */
const scriptURL = "https://script.google.com/macros/s/AKfycbxz8PwvKYOWkn4nsrk3mknu3fOv2bxn4-EJrEFtHsw_Vks3e6KBsvN_-EFlG27VObjENw/exec";
const UPI_ID = "9798789203@ptyes"; // your UPI id
const UPI_PAY_NAME = "ABVP Birsa"; // payee name shown in UPI apps
/* -------------------------- */

const form = document.getElementById('examForm');
const slip = document.getElementById('slip');
const slipDetails = document.getElementById('slipDetails');
const upiBlock = document.getElementById('upiBlock');
const entryQrBox = document.getElementById('entryQrBox');

function escapeHtml(text){ if(!text) return ''; return text.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m])); }

form.addEventListener('submit', e => {
  e.preventDefault();
  const data = new FormData(form);
  const file = data.get('screenshot');
  if(!file || !file.name){ alert("कृपया payment screenshot upload करें।"); return; }

  const reader = new FileReader();
  reader.onload = async () => {
    const base64Screenshot = reader.result.split(',')[1];
    const payload = {
      name: data.get('name'),
      education: data.get('education'),
      school: data.get('school'),
      gender: data.get('gender'),
      email: data.get('email'),
      mobile: data.get('mobile'),
      address: data.get('address'),
      txnid: data.get('txnid'),
      screenshot: base64Screenshot
    };

    try {
      // send to Apps Script
      const res = await fetch(scriptURL, {
        method: 'POST',
        body: JSON.stringify(payload),
        headers: {'Content-Type':'application/json'}
      });

      // parse response (may throw if not JSON)
      const result = await res.json();
      if(result.status !== "success") throw new Error(result.message || "Error saving data");

      const fileUrl = result.fileUrl || "#";

      // Fill slip details up to address
      slipDetails.innerHTML = `
        <p><b>नाम:</b> ${escapeHtml(payload.name)}</p>
        <p><b>शिक्षा:</b> ${escapeHtml(payload.education)}</p>
        <p><b>विद्यालय / कॉलेज:</b> ${escapeHtml(payload.school)}</p>
        <p><b>लिंग:</b> ${escapeHtml(payload.gender)}</p>
        <p><b>मोबाइल:</b> ${escapeHtml(payload.mobile)}</p>
        <p><b>पता:</b> ${escapeHtml(payload.address)}</p>
      `;

      // --- UPI block (show UPI id + QR) ---
      upiBlock.innerHTML = `
        <div class="qr-box" id="upiBox">
          <div class="small-muted">Scan to Pay</div>
          <div id="upiCanvas"></div>
          <div class="upi-id">${escapeHtml(UPI_ID)}</div>
          <div class="small-muted">UPI ID</div>
        </div>
      `;
      upiBlock.style.display = 'flex';

      // build UPI payment URI (amount left blank so user can enter)
      // format: upi://pay?pa=upiid&pn=payeeName&cu=INR
      const upiUri = `upi://pay?pa=${encodeURIComponent(UPI_ID)}&pn=${encodeURIComponent(UPI_PAY_NAME)}&cu=INR`;

      // render UPI QR
      const upiCanvasDiv = document.getElementById('upiCanvas');
      QRCode.toCanvas(upiCanvasDiv, upiUri, {width:170}, function(err){
        if(err) console.error("UPI QR error:", err);
      });

      // --- Student entry QR (Name + TxnID) ---
      entryQrBox.innerHTML = `
        <div class="qr-box" id="entryBox">
          <div class="small-muted">Entry QR</div>
          <div id="entryCanvas"></div>
          <div class="small-muted">Scan at venue</div>
        </div>
      `;
      entryQrBox.style.display = 'flex';

      const entryData = `Name: ${payload.name}\nTxnID: ${payload.txnid}`;
      const entryCanvasDiv = document.getElementById('entryCanvas');
      QRCode.toCanvas(entryCanvasDiv, entryData, {width:170}, function(err){
        if(err) console.error("Entry QR error:", err);
      });

      // After QR blocks, append Transaction ID and screenshot link to slipDetails
      slipDetails.innerHTML += `
        <p style="margin-top:12px;"><b>Transaction ID:</b> ${escapeHtml(payload.txnid)}</p>
        <p><b>Payment Screenshot:</b> <a href="${fileUrl}" target="_blank">यहाँ क्लिक करें</a></p>
      `;

      // show slip, hide form
      form.style.display = 'none';
      slip.style.display = 'block';
      window.scrollTo(0,0);

    } catch(err) {
      alert("डेटा Google Sheet/Drive में नहीं जा सका — कंसोल में error देखें। पर slip browser में दिख रही है।");
      console.error(err);
      // still show slip locally (without fileUrl)
      slipDetails.innerHTML = `
        <p><b>नाम:</b> ${escapeHtml(payload.name)}</p>
        <p><b>पता:</b> ${escapeHtml(payload.address)}</p>
        <p style="margin-top:12px;"><b>Transaction ID:</b> ${escapeHtml(payload.txnid)}</p>
      `;
      // attempt to show UPI and entry QR even on error
      upiBlock.style.display = 'flex';
      QRCode.toCanvas(document.getElementById('upiCanvas'), `upi://pay?pa=${encodeURIComponent(UPI_ID)}&pn=${encodeURIComponent(UPI_PAY_NAME)}&cu=INR`, {width:170});
      entryQrBox.style.display = 'flex';
      QRCode.toCanvas(document.getElementById('entryCanvas'), `Name: ${payload.name}\nTxnID: ${payload.txnid}`, {width:170});
      form.style.display='none';
      slip.style.display='block';
    }
  };
  reader.readAsDataURL(file);
});
</script>
</body>
</html>
