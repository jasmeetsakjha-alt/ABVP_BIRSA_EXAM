<div class="slip" id="slip">
  <h3>आपका प्रवेश पत्र</h3>
  <div id="slipDetails"></div>
  <div id="qrCode"></div> <!-- अब QR code slipDetails के बाद, Transaction ID से पहले -->
</div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbxz8PwvKYOWkn4nsrk3mknu3fOv2bxn4-EJrEFtHsw_Vks3e6KBsvN_-EFlG27VObjENw/exec";
const form = document.getElementById('examForm');
const slip = document.getElementById('slip');
const slipDetails = document.getElementById('slipDetails');
const qrCodeDiv = document.getElementById('qrCode');

form.addEventListener('submit', e => {
  e.preventDefault();
  const data = new FormData(form);
  const file = data.get('screenshot');
  if(!file || !file.name){ alert("कृपया payment screenshot upload करें।"); return; }

  const reader = new FileReader();
  reader.onload = async () => {
    const base64Screenshot = reader.result.split(',')[1];
    const payload = {
      name: data.get('name'),
      education: data.get('education'),
      school: data.get('school'),
      gender: data.get('gender'),
      email: data.get('email'),
      mobile: data.get('mobile'),
      address: data.get('address'),
      txnid: data.get('txnid'),
      screenshot: base64Screenshot
    };

    try {
      const res = await fetch(scriptURL, {
        method:'POST',
        body: JSON.stringify(payload),
        headers:{'Content-Type':'application/json'}
      });
      const result = await res.json();
      if(result.status !== "success") throw new Error(result.message || "Error saving data");

      const fileUrl = result.fileUrl;

      // slipDetails में नाम, शिक्षा, स्कूल, लिंग, मोबाइल, पता डालो
      slipDetails.innerHTML = `
        <p><b>नाम:</b> ${payload.name}</p>
        <p><b>शिक्षा:</b> ${payload.education}</p>
        <p><b>विद्यालय / कॉलेज:</b> ${payload.school}</p>
        <p><b>लिंग:</b> ${payload.gender}</p>
        <p><b>मोबाइल:</b> ${payload.mobile}</p>
        <p><b>पता:</b> ${payload.address}</p>
      `;

      // अब QR code generate करो (Transaction ID info के साथ)
      QRCode.toCanvas(qrCodeDiv, `Name: ${payload.name}\nTxnID: ${payload.txnid}`, {width:200}, function (error) {
        if(error) console.error(error);
      });

      // उसके बाद Transaction ID और screenshot
      slipDetails.innerHTML += `
        <p><b>Transaction ID:</b> ${payload.txnid}</p>
        <p><b>Payment Screenshot:</b> <a href="${fileUrl}" target="_blank">यहाँ क्लिक करें</a></p>
      `;

      form.style.display='none';
      slip.style.display='block';
      window.scrollTo(0,0);

    } catch(err) {
      alert("डेटा Google Sheet में नहीं जा सका। लेकिन slip दिख रही है।");
      console.error(err);
    }

  };
  reader.readAsDataURL(file);
});
</script>
